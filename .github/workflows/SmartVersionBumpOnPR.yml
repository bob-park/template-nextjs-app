name: Smart Version Bump on Merge

on:
  push:
    branches:
      - develop

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Make bump-version.sh executable
        run: chmod +x bump-version.sh

      - name: Get merged PR info
        id: merged-pr
        run: |
          # 최근 merge 커밋에서 PR 정보 추출
          MERGE_COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Merge commit message: $MERGE_COMMIT_MSG"
          
          # PR 번호 추출 (예: "Merge pull request #123 from ...")
          if [[ "$MERGE_COMMIT_MSG" =~ Merge\ pull\ request\ \#([0-9]+) ]]; then
            PR_NUMBER="${BASH_REMATCH[1]}"
            echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Found PR number: $PR_NUMBER"
          else
            echo "PR_NUMBER=" >> $GITHUB_OUTPUT
            echo "No PR number found in merge commit"
          fi

      - name: Get PR details
        if: steps.merged-pr.outputs.PR_NUMBER != ''
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.merged-pr.outputs.PR_NUMBER }};
            try {
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
            
              core.setOutput('title', pr.title);
              core.setOutput('labels', pr.labels.map(label => label.name).join(' '));
            } catch (error) {
              console.log('Error fetching PR details:', error);
              core.setOutput('title', '');
              core.setOutput('labels', '');
            }

      - name: Determine version bump type
        id: bump-type
        run: |
          PR_TITLE="${{ steps.pr-details.outputs.title }}"
          LABELS="${{ steps.pr-details.outputs.labels }}"
          
          echo "PR Title: $PR_TITLE"
          echo "Labels: $LABELS"
          
          if [[ "$LABELS" == *"major"* ]] || [[ "$PR_TITLE" == *"[major]"* ]]; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif [[ "$LABELS" == *"minor"* ]] || [[ "$PR_TITLE" == *"[minor]"* ]]; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif [[ "$LABELS" == *"date"* ]] || [[ "$PR_TITLE" == *"[date]"* ]]; then
            echo "type=date" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Run bump-version script
        run: ./bump-version.sh ${{ steps.bump-type.outputs.type }}

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit version bump
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          NEW_VERSION=$(jq -r '.version' ./package.json)
          git add package.json
          git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
          git push origin develop
