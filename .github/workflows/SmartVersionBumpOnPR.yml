name: Smart Version Bump on PR

on:
  pull_request:
    types: [opened, synchronize, labeled]
    branches:
      - develop

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Make bump-version.sh executable
      run: chmod +x bump-version.sh

    - name: Determine version bump type
      id: bump-type
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        LABELS="${{ join(github.event.pull_request.labels.*.name, ' ') }}"
        
        if [[ "$LABELS" == *"major"* ]] || [[ "$PR_TITLE" == *"[major]"* ]]; then
          echo "type=major" >> $GITHUB_OUTPUT
        elif [[ "$LABELS" == *"minor"* ]] || [[ "$PR_TITLE" == *"[minor]"* ]]; then
          echo "type=minor" >> $GITHUB_OUTPUT
        elif [[ "$LABELS" == *"date"* ]] || [[ "$PR_TITLE" == *"[date]"* ]]; then
          echo "type=date" >> $GITHUB_OUTPUT
        else
          echo "type=patch" >> $GITHUB_OUTPUT
        fi

    - name: Run bump-version script
      run: ./bump-version.sh ${{ steps.bump-type.outputs.type }}

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit version bump
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        NEW_VERSION=$(grep "^version = " package.json | sed "s/version = '//" | sed "s/'//")
        git add package.json
        git commit -m "chore: bump version to ${NEW_VERSION} [skip ci]"
        git push origin HEAD:${{ github.head_ref }}

    - name: Comment on PR
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const version = fs.readFileSync('package.json', 'utf8')
            .match(/version = '(.+)'/)[1];
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ ë²„ì „ì´ ìë™ìœ¼ë¡œ **${version}**ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`
          });
